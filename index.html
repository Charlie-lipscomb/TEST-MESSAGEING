<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whisp Chat</title>
<style>
  body { font-family: system-ui, sans-serif; margin:0; background:#dcefff; display:flex; justify-content:center; }
  main { width:100%; max-width:600px; height:100vh; background:#fff; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
  header { background:#a1cfff; color:white; padding:14px; text-align:center; font-weight:600;}
  .screen { display:none; flex-direction:column; flex:1; }
  .screen.active { display:flex; }
  input, textarea, button { font-family:inherit; font-size:1rem; }
  .auth { padding:20px; display:flex; flex-direction:column; gap:10px; }
  .auth input { padding:10px; border-radius:6px; border:1px solid #ccc; }
  .auth button { background:#70b7ff; color:white; border:none; border-radius:6px; padding:10px; cursor:pointer; font-weight:600; }
  #chatList { flex:1; overflow-y:auto; padding:10px; }
  .chat-item { padding:12px; border-bottom:1px solid #ddd; cursor:pointer; }
  .chat-item:hover { background:#f0f8ff; }
  #chatHeader { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#a1cfff; color:white; }
  #chatHeader button { background:#70b7ff; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
  #chatTitle { font-weight:bold; text-align:center; flex:1; margin:0 10px; }
  #messages { flex:1; overflow-y:auto; padding:10px; background:#e6f2ff; display:flex; flex-direction:column; }
  .msg { max-width:70%; padding:10px 14px; border-radius:10px; margin:6px 0; font-size:0.95rem; word-break:break-word; }
  .you { align-self:flex-end; background:#cce7ff; }
  .other { align-self:flex-start; background:#fff; }
  form { display:flex; padding:10px; background:#f0f0f0; }
  textarea { flex:1; padding:10px; border-radius:20px; border:none; resize:none; outline:none; }
  button.send { background:#a1cfff; color:white; border:none; border-radius:50%; width:42px; height:42px; margin-left:8px; font-size:1.2rem; cursor:pointer; }
</style>
</head>
<body>
<main>
  <header>Whisp Chat</header>

  <!-- AUTH SCREEN -->
  <div id="authScreen" class="screen active">
    <div class="auth">
      <input id="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <input id="username" placeholder="Username (new users)">
      <button id="signup">Sign Up</button>
      <button id="login">Log In</button>
    </div>
  </div>

  <!-- CHAT LIST SCREEN -->
  <div id="chatListScreen" class="screen">
    <button id="newGroup" style="margin:10px;">âž• New Group</button>
    <div id="chatList"></div>
  </div>

  <!-- CHAT SCREEN -->
  <div id="chatScreen" class="screen">
    <div id="chatHeader">
      <button id="backBtn">â¬… Back</button>
      <span id="chatTitle">Chat</span>
      <button id="dmBtn">ðŸ’¬ DM</button>
    </div>
    <div id="messages"></div>
    <form id="chatForm" onsubmit="return false;">
      <textarea id="message" placeholder="Type a message..."></textarea>
      <button class="send" id="send">âž¤</button>
    </form>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

// ðŸ”§ Replace with your Firebase config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const authScreen = document.getElementById("authScreen");
const chatListScreen = document.getElementById("chatListScreen");
const chatScreen = document.getElementById("chatScreen");
const chatList = document.getElementById("chatList");
const messagesDiv = document.getElementById("messages");

let currentUser = null;
let currentChatId = null;

const show = (el) => {
  [authScreen, chatListScreen, chatScreen].forEach(s => s.classList.remove("active"));
  el.classList.add("active");
};

// SIGN UP
document.getElementById("signup").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const username = document.getElementById("username").value.trim();
  if(!email || !password || !username) return alert("Fill all fields");
  try {
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    await set(ref(db,"users/"+cred.user.uid),{username,email});
    alert("Account created!");
  } catch(err){ alert(err.message); }
};

// LOG IN
document.getElementById("login").onclick = async ()=>{
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  try { await signInWithEmailAndPassword(auth,email,password); }
  catch(err){ alert(err.message); }
};

// AUTH STATE
onAuthStateChanged(auth, async (user)=>{
  if(user){ currentUser = user; show(chatListScreen); loadChats(); }
  else { show(authScreen); }
});

// LOAD CHATS
async function loadChats(){
  chatList.innerHTML="";
  const snapshot = await get(ref(db,"chats"));
  if(!snapshot.exists()) return;
  snapshot.forEach(chatSnap=>{
    const chat = chatSnap.val();
    if(chat.members && chat.members.includes(currentUser.uid)){
      const div=document.createElement("div");
      div.classList.add("chat-item");
      div.textContent = chat.isGroup ? "ðŸ‘¥ "+chat.name : "ðŸ’¬ "+chat.name;
      div.onclick = ()=> openChat(chatSnap.key, chat.name);
      chatList.appendChild(div);
    }
  });
}

// OPEN CHAT
async function openChat(chatId, chatName="Chat"){
  currentChatId = chatId;
  show(chatScreen);
  messagesDiv.innerHTML="";
  document.getElementById("chatTitle").textContent = chatName;
  const messagesRef = ref(db,`chats/${chatId}/messages`);
  onChildAdded(messagesRef, (snap)=>{
    const msg = snap.val();
    const div = document.createElement("div");
    div.classList.add("msg", msg.sender === currentUser.uid ? "you" : "other");
    div.innerHTML = `<strong>${msg.sender}</strong>: ${msg.text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// SEND MESSAGE
document.getElementById("send").onclick = async ()=>{
  const msgInput = document.getElementById("message");
  if(!msgInput.value.trim() || !currentChatId) return;
  await push(ref(db,`chats/${currentChatId}/messages`),{
    sender: currentUser.uid,
    text: msgInput.value.trim(),
    time:Date.now()
  });
  msgInput.value="";
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
};

// BACK BUTTON
document.getElementById("backBtn").onclick = ()=>{
  currentChatId=null;
  messagesDiv.innerHTML="";
  show(chatListScreen);
};

// NEW GROUP
document.getElementById("newGroup").onclick=async ()=>{
  const name=prompt("Group name:");
  if(!name) return;
  const newChatRef = push(ref(db,"chats"));
  await set(newChatRef,{
    name,
    isGroup:true,
    members:[currentUser.uid]
  });
  loadChats();
};

// DIRECT MESSAGE
document.getElementById("dmBtn").onclick=async ()=>{
  const targetUsername=prompt("Enter username to DM:");
  if(!targetUsername) return;
  const usersSnap = await get(ref(db,"users"));
  let targetUser = null;
  usersSnap.forEach(u=>{
    const val = u.val();
    if(val.username.toLowerCase() === targetUsername.toLowerCase()){
      targetUser = { uid: u.key, username: val.username };
    }
  });
  if(!targetUser) return alert("User not found.");
  
  // Check for existing chat
  const chatsSnap = await get(ref(db,"chats"));
  let chatId = null;
  if(chatsSnap.exists()){
    chatsSnap.forEach(c=>{
      const chat = c.val();
      if(!chat.isGroup && chat.members.includes(currentUser.uid) && chat.members.includes(targetUser.uid)){
        chatId = c.key;
      }
    });
  }

  // If not found, create new DM
  if(!chatId){
    const newChatRef = push(ref(db,"chats"));
    await set(newChatRef,{
      isGroup:false,
      members:[currentUser.uid, targetUser.uid],
      name:targetUser.username
    });
    chatId = newChatRef.key;
  }

  openChat(chatId, targetUser.username);
};
</script>
</body>
</html>
