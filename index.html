<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Whisp</title>
<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: #eef5ff;
  color: #222;
}
#loginScreen, #chatListScreen, #chatScreen {
  display: none;
  height: 100vh;
}
.active {
  display: flex;
  flex-direction: column;
}
#loginScreen {
  justify-content: center;
  align-items: center;
}
#loginScreen input {
  display: block;
  margin: 8px 0;
  padding: 8px;
  width: 220px;
}
#chatListScreen {
  background: #fff;
}
#chatList {
  flex: 1;
  overflow-y: auto;
}
.chatItem {
  padding: 14px;
  border-bottom: 1px solid #ccc;
  cursor: pointer;
}
.chatItem.unread {
  font-weight: bold;
}
#chatHeader {
  background: #1a73e8;
  color: white;
  padding: 10px;
  text-align: center;
}
#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}
.msg {
  margin-bottom: 10px;
  max-width: 80%;
  padding: 8px 10px;
  border-radius: 12px;
  word-wrap: break-word;
}
.me {
  align-self: flex-end;
  background: #cde0ff;
}
.them {
  align-self: flex-start;
  background: #fff;
  border: 1px solid #ccc;
}
.senderLabel {
  font-size: 0.8rem;
  font-weight: 600;
  color: #1a73e8;
  margin-bottom: 2px;
}
.timestamp {
  font-size: 0.7rem;
  text-align: right;
  opacity: 0.6;
}
#inputBar {
  display: flex;
  padding: 8px;
  background: #f3f6ff;
}
#inputBar input {
  flex: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 10px;
}
#inputBar button {
  margin-left: 8px;
  padding: 8px 12px;
  background: #1a73e8;
  color: white;
  border: none;
  border-radius: 10px;
}
</style>
</head>
<body>
<div id="loginScreen" class="active">
  <h2>Whisp ðŸ’¬</h2>
  <input id="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <input id="username" placeholder="Username (for signup)" />
  <button id="loginBtn">Login / Register</button>
</div>

<div id="chatListScreen">
  <h2 style="background:#1a73e8;color:white;margin:0;padding:10px;">Chats</h2>
  <div id="chatList"></div>
  <button id="newChatBtn" style="padding:10px;background:#1a73e8;color:white;border:none;width:100%;">New Chat</button>
</div>

<div id="chatScreen">
  <div id="chatHeader"><span id="chatName"></span></div>
  <div id="messages"></div>
  <div id="inputBar">
    <input id="messageInput" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import {
  getDatabase, ref, get, push, set, onChildAdded, onValue, off, update
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword,
  createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEdtncZpDgOSnULIjopee7GKh9h9hveKk",
  authDomain: "messagingapp-7ede5.firebaseapp.com",
  databaseURL: "https://messagingapp-7ede5-default-rtdb.firebaseio.com",
  projectId: "messagingapp-7ede5",
  storageBucket: "messagingapp-7ede5.firebasestorage.app",
  messagingSenderId: "221896974865",
  appId: "1:221896974865:web:3faca4885e48ee656907b0"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const loginScreen = document.getElementById("loginScreen");
const chatListScreen = document.getElementById("chatListScreen");
const chatScreen = document.getElementById("chatScreen");
const chatList = document.getElementById("chatList");
const messagesDiv = document.getElementById("messages");
let currentUser, currentChatId, currentChatIsGroup=false, currentListenerRef=null, chatMembers={}, unreadChats=new Set();

function show(el) {
  [loginScreen, chatListScreen, chatScreen].forEach(e => e.classList.remove("active"));
  el.classList.add("active");
}

// --- AUTH ---
document.getElementById("loginBtn").onclick = async () => {
  const email = email.value.trim();
  const password = password.value.trim();
  const username = username.value.trim();
  try {
    let cred;
    try {
      cred = await signInWithEmailAndPassword(auth, email, password);
    } catch {
      cred = await createUserWithEmailAndPassword(auth, email, password);
      await set(ref(db, "users/" + cred.user.uid), { username, email });
    }
  } catch (e) {
    alert(e.message);
  }
};

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    loadChats();
    show(chatListScreen);
  }
});

// --- LOAD CHATS ---
async function loadChats() {
  chatList.innerHTML = "";
  const userChatsRef = ref(db, "userChats/" + currentUser.uid);
  onValue(userChatsRef, async (snap) => {
    chatList.innerHTML = "";
    if (!snap.exists()) return;
    for (const [chatId, chatName] of Object.entries(snap.val())) {
      const div = document.createElement("div");
      div.className = "chatItem";
      div.textContent = chatName;
      if (unreadChats.has(chatId)) div.classList.add("unread");
      div.onclick = () => openChat(chatId, chatName);
      chatList.append(div);
    }
  });
}

// --- OPEN CHAT ---
async function openChat(id, name) {
  currentChatId = id;
  document.getElementById("chatName").textContent = name;
  messagesDiv.innerHTML = "";
  show(chatScreen);
  unreadChats.delete(id);
  loadChats();

  if (currentListenerRef) off(currentListenerRef);

  const chatSnap = await get(ref(db, "chats/" + id));
  const chat = chatSnap.val() || {};
  currentChatIsGroup = chat.isGroup || false;

  chatMembers = {};
  if (chat.members) {
    for (const uid of chat.members) {
      const uSnap = await get(ref(db, "users/" + uid));
      if (uSnap.exists()) chatMembers[uid] = uSnap.val().username || "Unknown";
    }
  }

  const msgRef = ref(db, "chats/" + id + "/messages");
  currentListenerRef = msgRef;
  onChildAdded(msgRef, (s) => {
    renderMessage(s.val());
  });
}

// --- RENDER MESSAGE ---
function renderMessage(m) {
  const div = document.createElement("div");
  div.classList.add("msg", m.sender === currentUser.uid ? "me" : "them");

  if (currentChatIsGroup && m.sender !== currentUser.uid) {
    const uname = chatMembers[m.sender] || "Unknown";
    const label = document.createElement("div");
    label.className = "senderLabel";
    label.textContent = uname;
    div.append(label);
  }

  div.append(document.createTextNode(m.text));
  const time = document.createElement("div");
  time.className = "timestamp";
  time.textContent = new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  div.append(time);

  messagesDiv.append(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// --- SEND MESSAGE ---
document.getElementById("sendBtn").onclick = async () => {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (!text) return;
  input.value = "";
  const msg = {
    sender: currentUser.uid,
    text,
    time: Date.now()
  };
  await push(ref(db, "chats/" + currentChatId + "/messages"), msg);

  // mark unread for other members
  const chatSnap = await get(ref(db, "chats/" + currentChatId));
  const chat = chatSnap.val();
  if (chat.members) {
    for (const uid of chat.members) {
      if (uid !== currentUser.uid) {
        await update(ref(db, "userChats/" + uid + "/" + currentChatId), { unread: true });
      }
    }
  }
};

// --- Detect Unread ---
onValue(ref(db, "userChats/" + (auth.currentUser?.uid || "none")), (snap) => {
  if (!snap.exists()) return;
  for (const [chatId, data] of Object.entries(snap.val())) {
    if (data.unread) unreadChats.add(chatId);
  }
  loadChats();
});
</script>
</body>
</html>
