<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Whisp</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --cream:#f7f3e8;
  --accent:#223294;
  --accent-contrast:#fff;
  --muted:#6b6b6b;
  --panel-border:rgba(34,50,148,0.08);
  --bubble-other:#ffffff;
  --bubble-other-border:rgba(0,0,0,0.06);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,sans-serif;background:var(--cream);color:#111}
main{height:100%;display:flex;flex-direction:column;}

/* screens */
.screen{display:none;flex-direction:column;height:100%}
.screen.active{display:flex}

/* login */
#loginScreen{display:flex;justify-content:center;align-items:center;padding:24px}
.login-card{width:100%;max-width:420px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(34,50,148,0.06);padding:28px}
.brand{color:var(--accent);font-weight:700;font-size:1.75rem;margin-bottom:6px;text-align:center}
.login-sub{color:var(--muted);margin-bottom:18px;text-align:center}
.input{display:block;width:100%;padding:12px 14px;margin-bottom:12px;border-radius:10px;border:1px solid var(--panel-border);background:transparent;outline:none;font-size:0.95rem}
#loginBtn{width:100%;padding:12px;border-radius:10px;border:none;background:var(--accent);color:var(--accent-contrast);font-weight:700;cursor:pointer}

/* chat list */
#chatListScreen{flex:1;display:flex;flex-direction:column}
#chatListHeader{background:var(--accent);color:var(--accent-contrast);padding:14px 16px;display:flex;justify-content:space-between;align-items:center;font-weight:600}
#chatList{flex:1;overflow:auto;padding:8px 0;background:var(--cream)}
.chatItem{padding:12px 16px;border-bottom:1px solid var(--panel-border);cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:transparent}
.chatItem:hover{background:rgba(34,50,148,0.03)}
.chatItem.unread{font-weight:700;background:rgba(34,50,148,0.06);border-left:4px solid var(--accent);padding-left:12px}

/* bottom menu */
#bottomMenu{display:flex;justify-content:space-around;align-items:center;position:fixed;bottom:0;left:0;width:100%;background:var(--accent);padding:10px 0;box-shadow:0 -8px 20px rgba(34,50,148,0.06)}
#bottomMenu button{background:var(--cream);border:none;color:var(--accent);padding:8px 14px;border-radius:8px;font-weight:600;cursor:pointer}

/* chat screen */
#chatScreen{display:flex;flex-direction:column;height:100%}
#chatHeader{background:var(--accent);color:var(--accent-contrast);padding:12px 16px;display:flex;align-items:center;gap:12px}
#chatHeader .back{background:none;border:none;color:var(--accent-contrast);font-size:1.1rem;cursor:pointer}
#chatName{font-weight:700}
#messages{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:8px;background:var(--cream)}
.msg{max-width:78%;padding:10px 14px;border-radius:14px;word-wrap:break-word;line-height:1.3}
.me{align-self:flex-end;background:var(--accent);color:var(--accent-contrast);box-shadow:0 6px 18px rgba(34,50,148,0.06)}
.them{align-self:flex-start;background:var(--bubble-other);color:#111;border:1px solid var(--bubble-other-border)}
.sender{font-size:0.8rem;color:var(--accent);font-weight:600;margin-bottom:6px}
.reply-preview{font-size:0.85rem;color:#444;border-left:3px solid var(--accent);padding-left:8px;margin-bottom:8px;background:transparent}
.timestamp{font-size:0.75rem;color:var(--muted);margin-top:6px;text-align:right}

/* reply bar and input */
#replyBar{display:none;padding:8px 12px;background:rgba(34,50,148,0.04);border-left:4px solid var(--accent);align-items:center;gap:8px}
#replyText{flex:1;color:#222;font-size:0.95rem}
#cancelReply{background:none;border:none;color:var(--accent);font-weight:600;cursor:pointer}
#inputBar{display:flex;gap:8px;padding:10px;border-top:1px solid var(--panel-border);background:var(--cream);align-items:center}
#message{flex:1;padding:12px;border-radius:999px;border:1px solid var(--panel-border);outline:none;background:#fff}
#sendBtn{width:46px;height:46px;border-radius:999px;border:none;background:var(--accent);color:var(--accent-contrast);font-size:1.05rem;cursor:pointer}

/* responsiveness */
@media(min-width:700px){
  main{max-width:760px;margin:30px auto;border-radius:12px;overflow:hidden;box-shadow:0 12px 40px rgba(34,50,148,0.06)}
  #bottomMenu{position:static;border-top:1px solid var(--panel-border)}
  .login-card{max-width:520px}
}
</style>
</head>
<body>
<main>
  <!-- Login screen -->
  <section id="loginScreen" class="screen active">
    <div class="login-card" role="form" aria-labelledby="brand">
      <div id="brand" class="brand">Whisp</div>
      <div class="login-sub">Sign in or register to continue</div>
      <input id="email" class="input" placeholder="Email" inputmode="email">
      <input id="password" class="input" type="password" placeholder="Password">
      <input id="username" class="input" placeholder="Username (for signup)">
      <button id="loginBtn">Login / Register</button>
    </div>
  </section>

  <!-- Chat list -->
  <section id="chatListScreen" class="screen">
    <div id="chatListHeader">Whisp Chats</div>
    <div id="chatList" aria-live="polite"></div>
    <div id="bottomMenu">
      <button id="dmBtn">DM</button>
      <button id="groupBtn">Group</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </section>

  <!-- Chat -->
  <section id="chatScreen" class="screen" aria-live="polite">
    <div id="chatHeader">
      <button id="backBtn" class="back">←</button>
      <span id="chatName">Chat</span>
    </div>
    <div id="messages" role="log"></div>
    <div id="replyBar">
      <span id="replyText"></span>
      <button id="cancelReply">✖</button>
    </div>
    <div id="inputBar">
      <input id="message" placeholder="Type a message..." autocomplete="off">
      <button id="sendBtn">➤</button>
    </div>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, set, push, get, onChildAdded, onValue, off, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEdtncZpDgOSnULIjopee7GKh9h9hveKk",
  authDomain: "messagingapp-7ede5.firebaseapp.com",
  databaseURL: "https://messagingapp-7ede5-default-rtdb.firebaseio.com",
  projectId: "messagingapp-7ede5",
  storageBucket: "messagingapp-7ede5.firebasestorage.app",
  messagingSenderId: "221896974865",
  appId: "1:221896974865:web:3faca4885e48ee656907b0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* UI refs */
const loginScreen=document.getElementById("loginScreen"),
      chatListScreen=document.getElementById("chatListScreen"),
      chatScreen=document.getElementById("chatScreen"),
      chatList=document.getElementById("chatList"),
      messagesDiv=document.getElementById("messages"),
      replyBar=document.getElementById("replyBar"),
      replyText=document.getElementById("replyText"),
      cancelReplyBtn=document.getElementById("cancelReply"),
      messageInput=document.getElementById("message");

let currentUser=null, currentChatId=null, replyTo=null, currentListenerRef=null;
let currentChatIsGroup=false, chatMembers={};

const show=(s)=>{[loginScreen,chatListScreen,chatScreen].forEach(e=>e.classList.remove("active"));s.classList.add("active");};

/* login/register */
document.getElementById("loginBtn").onclick=async()=>{
  const email=document.getElementById("email").value.trim();
  const pass=document.getElementById("password").value.trim();
  const uname=document.getElementById("username").value.trim();
  if(!email||!pass) return alert("Enter credentials");
  try{
    let cred;
    try{ cred=await signInWithEmailAndPassword(auth,email,pass); }
    catch{ 
      cred=await createUserWithEmailAndPassword(auth,email,pass);
      await set(ref(db,"users/"+cred.user.uid),{username:uname||email.split("@")[0],email});
    }
  }catch(e){alert(e.message)}
};

/* auth listener */
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser=user;
    await loadChats();
    show(chatListScreen);
    listenForUnread();
  }else show(loginScreen);
});

/* load chats */
async function loadChats(){
  chatList.innerHTML="";
  const chatsSnap=await get(ref(db,"chats"));
  if(chatsSnap.exists()){
    chatsSnap.forEach(c=>{
      const chat=c.val();
      if(chat.members && chat.members.includes(currentUser.uid)){
        const div=document.createElement("div");
        div.className="chatItem";
        div.dataset.id=c.key;
        div.textContent=chat.name;
        div.onclick=()=>openChat(c.key,chat.name);
        chatList.append(div);
      }
    });
  }
}

/* open chat */
async function openChat(id,name){
  currentChatId=id;
  document.getElementById("chatName").textContent=name;
  messagesDiv.innerHTML="";
  show(chatScreen);
  if(currentListenerRef){ off(currentListenerRef); }

  const chatSnap=await get(ref(db,"chats/"+id));
  const chat=chatSnap.val();
  currentChatIsGroup=chat.isGroup||false;

  chatMembers={};
  if(chat.members){
    for(const uid of chat.members){
      const uSnap=await get(ref(db,"users/"+uid));
      if(uSnap.exists()) chatMembers[uid]=uSnap.val().username||"Unknown";
    }
  }

  await update(ref(db,"userChats/"+currentUser.uid+"/"+id),{unread:false});

  const msgRef=ref(db,"chats/"+id+"/messages");
  currentListenerRef=msgRef;
  onChildAdded(msgRef,s=>renderMessage(s.val()));
}

/* render message */
function renderMessage(m){
  const div=document.createElement("div");
  div.classList.add("msg",m.sender===currentUser.uid?"me":"them");
  let senderLabel="";
  if(currentChatIsGroup && m.sender!==currentUser.uid){
    senderLabel=`<div class="sender">${chatMembers[m.sender]||"Unknown"}</div>`;
  }
  div.innerHTML=`
    ${senderLabel}
    ${m.replyTo?`<div class="reply-preview">${m.replyTo}</div>`:""}
    ${m.text}
    <div class="timestamp">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
  `;
  messagesDiv.append(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;

  div.onclick=()=>showReplyBar(m.text);
  if(m.sender!==currentUser.uid) showNotification("New message",m.text);
}

/* reply bar */
function showReplyBar(text){ replyTo=text; replyBar.style.display="flex"; replyText.textContent="Replying: "+text.slice(0,40); }
cancelReplyBtn.onclick=()=>{replyTo=null;replyBar.style.display="none";};

/* send */
document.getElementById("sendBtn").onclick=async()=>{
  const text=messageInput.value.trim();
  if(!text||!currentChatId) return;
  await push(ref(db,"chats/"+currentChatId+"/messages"),{sender:currentUser.uid,text,replyTo,time:Date.now()});
  messageInput.value="";
  replyTo=null;
  replyBar.style.display="none";
};

/* back and logout */
document.getElementById("backBtn").onclick=()=>{
  currentChatId=null; if(currentListenerRef) off(currentListenerRef); show(chatListScreen);
};
document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth); currentUser=null; show(loginScreen);
};

/* group & DM */
document.getElementById("groupBtn").onclick=async()=>{
  const name=prompt("Group name:"); if(!name)return;
  const input=prompt("Enter usernames (comma-separated):");
  const usernames=input?input.split(",").map(u=>u.trim()):[];
  const usersSnap=await get(ref(db,"users"));
  const memberIds=[currentUser.uid];
  usersSnap.forEach(u=>{if(usernames.includes(u.val().username)) memberIds.push(u.key);});
  const refNew=push(ref(db,"chats"));
  await set(refNew,{name,isGroup:true,members:memberIds});
  loadChats();
};
document.getElementById("dmBtn").onclick=async()=>{
  const uname=prompt("Username to DM:"); if(!uname)return;
  const users=await get(ref(db,"users")); let uid=null;
  users.forEach(u=>{if(u.val().username===uname) uid=u.key;});
  if(!uid) return alert("User not found");
  const refNew=push(ref(db,"chats"));
  await set(refNew,{name:uname,isGroup:false,members:[currentUser.uid,uid]});
  loadChats();
};

/* unread logic */
function listenForUnread(){
  const userChatsRef=ref(db,"userChats/"+currentUser.uid);
  onValue(userChatsRef,snap=>{
    if(!snap.exists())return;
    snap.forEach(child=>{
      const chatId=child.key;
      const data=child.val();
      const chatDiv=[...chatList.children].find(d=>d.dataset.id===chatId);
      if(chatDiv){ if(data.unread) chatDiv.classList.add("unread"); else chatDiv.classList.remove("unread"); }
    });
  });

  onValue(ref(db,"chats"),snap=>{
    if(!snap.exists()) return;
    snap.forEach(chatSnap=>{
      const chatId=chatSnap.key; const chat=chatSnap.val();
      if(!chat.members||!chat.members.includes(currentUser.uid)) return;
      const msgRef=ref(db,"chats/"+chatId+"/messages");
      onChildAdded(msgRef,msg=>{
        const m=msg.val();
        if(m.sender!==currentUser.uid && currentChatId!==chatId){
          update(ref(db,"userChats/"+currentUser.uid+"/"+chatId),{unread:true});
        }
      });
    });
  });
}

/* service worker & notifications */
if("serviceWorker"in navigator){navigator.serviceWorker.register("sw.js").then(()=>Notification.requestPermission());}
function showNotification(title,body){
  if(!("Notification"in window))return;
  if(Notification.permission==="granted"){
    navigator.serviceWorker.ready.then(r=>r.showNotification(title,{body,icon:"https://cdn-icons-png.flaticon.com/512/906/906349.png"}));
  }
}
</script>
</body>
</html>
