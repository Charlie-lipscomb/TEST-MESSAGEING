<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whisp</title>
<style>
html,body{margin:0;padding:0;height:100%;background:#e8f0fe;font-family:"Segoe UI",Roboto,sans-serif;}
main{height:100%;display:flex;flex-direction:column;}
.screen{display:none;flex-direction:column;height:100%;}
.screen.active{display:flex;}

/* Login */
#loginScreen{justify-content:center;align-items:center;background:#1a73e8;color:white;text-align:center;padding:20px;display:flex;flex-direction:column;}
#loginScreen h2{font-size:2rem;margin-bottom:20px;}
#loginScreen input{display:block;width:80%;margin:8px auto;padding:10px;border-radius:8px;border:none;font-size:1rem;}
#loginBtn{background:#4285f4;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 2px 5px rgba(0,0,0,0.2);}

/* Chat List */
#chatListScreen{background:#fff;flex:1;display:flex;flex-direction:column;}
#chatListHeader{background:#1a73e8;color:white;padding:14px;display:flex;justify-content:space-between;align-items:center;font-weight:600;}
#chatList{flex:1;overflow-y:auto;padding-bottom:70px;}
.chatItem{padding:14px;border-bottom:1px solid #eee;cursor:pointer;}
.chatItem:hover{background:#f1f5ff;}

/* Bottom Menu */
#bottomMenu{display:flex;justify-content:space-around;align-items:center;position:fixed;bottom:0;left:0;width:100%;background:#1a73e8;padding:10px 0;}
#bottomMenu button{background:#fff;border:none;color:#1a73e8;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;}

/* Chat */
#chatScreen{background:#e8f0fe;flex:1;display:flex;flex-direction:column;}
#chatHeader{background:#1a73e8;color:white;padding:12px;display:flex;justify-content:space-between;align-items:center;}
#chatHeader button{background:none;border:none;color:white;font-size:1rem;cursor:pointer;}
#messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;}
.msg{max-width:80%;margin-bottom:10px;padding:8px 12px;border-radius:10px;position:relative;word-wrap:break-word;}
.me{align-self:flex-end;background:#cfe2ff;}
.them{align-self:flex-start;background:#fff;}
.timestamp{font-size:0.75rem;color:#666;text-align:right;margin-top:2px;}
.readReceipt{font-size:0.75rem;color:#1a73e8;margin-left:5px;}

/* Reply Bar */
#replyBar{display:none;background:#e3f2fd;padding:6px 10px;border-left:4px solid #1a73e8;font-size:0.9rem;align-items:center;display:flex;justify-content:space-between;}
#replyText{flex:1;}
#cancelReply{background:none;border:none;color:#1a73e8;font-weight:bold;cursor:pointer;margin-left:10px;}

/* Typing Indicator */
#typingIndicator{font-size:0.85rem;color:#555;padding:4px 10px;height:18px;}

/* Input Bar */
#inputBar{display:flex;align-items:center;background:#fff;padding:8px;border-top:1px solid #ccc;}
#message{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;outline:none;}
#sendBtn{background:#1a73e8;color:white;border:none;border-radius:50%;width:42px;height:42px;margin-left:8px;font-size:1.2rem;cursor:pointer;}

@media(min-width:700px){main{max-width:600px;margin:auto;border-radius:10px;overflow:hidden;}#bottomMenu{position:static;border-top:1px solid #ccc;}}
</style>
</head>
<body>
<main>
  <section id="loginScreen" class="screen active">
    <h2>Welcome to Whisp üí¨</h2>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Password" />
    <input id="username" placeholder="Username (for signup)" />
    <button id="loginBtn">Login / Register</button>
  </section>

  <section id="chatListScreen" class="screen">
    <div id="chatListHeader">Whisp Chats</div>
    <div id="chatList"></div>
    <div id="bottomMenu">
      <button id="dmBtn">DM</button>
      <button id="groupBtn">Group</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </section>

  <section id="chatScreen" class="screen">
    <div id="chatHeader">
      <button id="backBtn">‚Üê</button>
      <span id="chatName">Chat</span>
    </div>
    <div id="messages"></div>
    <div id="typingIndicator"></div>
    <div id="replyBar">
      <span id="replyText"></span>
      <button id="cancelReply">‚úñ</button>
    </div>
    <div id="inputBar">
      <input id="message" placeholder="Type a message..." />
      <button id="sendBtn">‚û§</button>
    </div>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, set, push, get, onChildAdded, onValue, off, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEdtncZpDgOSnULIjopee7GKh9h9hveKk",
  authDomain: "messagingapp-7ede5.firebaseapp.com",
  databaseURL: "https://messagingapp-7ede5-default-rtdb.firebaseio.com",
  projectId: "messagingapp-7ede5",
  storageBucket: "messagingapp-7ede5.firebasestorage.app",
  messagingSenderId: "221896974865",
  appId: "1:221896974865:web:3faca4885e48ee656907b0"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const loginScreen=document.getElementById("loginScreen"),
      chatListScreen=document.getElementById("chatListScreen"),
      chatScreen=document.getElementById("chatScreen"),
      chatList=document.getElementById("chatList"),
      messagesDiv=document.getElementById("messages"),
      replyBar=document.getElementById("replyBar"),
      replyText=document.getElementById("replyText"),
      cancelReplyBtn=document.getElementById("cancelReply"),
      messageInput=document.getElementById("message"),
      typingIndicator=document.getElementById("typingIndicator");

let currentUser=null, currentChatId=null, replyTo=null, currentListenerRef=null, typingRef=null;
const show=(s)=>{[loginScreen,chatListScreen,chatScreen].forEach(e=>e.classList.remove("active"));s.classList.add("active");};

// Login / Signup
document.getElementById("loginBtn").onclick=async()=>{
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  const username=document.getElementById("username").value.trim();
  if(!email||!password)return alert("Enter credentials.");
  try{
    const cred=await signInWithEmailAndPassword(auth,email,password);
    currentUser=cred.user;
  }catch{
    const cred=await createUserWithEmailAndPassword(auth,email,password);
    currentUser=cred.user;
    await set(ref(db,"users/"+currentUser.uid),{username,email});
  }
};

onAuthStateChanged(auth,user=>{
  if(user){currentUser=user;loadChats();show(chatListScreen);}else{show(loginScreen);}
});

// Load chats
async function loadChats(){
  chatList.innerHTML="";
  const chatsSnap=await get(ref(db,"chats"));
  if(chatsSnap.exists()){
    chatsSnap.forEach(c=>{
      const chat=c.val();
      if(chat.members&&chat.members.includes(currentUser.uid)){
        const div=document.createElement("div");
        div.className="chatItem";
        div.textContent=chat.name;
        div.onclick=()=>openChat(c.key,chat.name);
        chatList.append(div);
      }
    });
  }
}

// Open chat
async function openChat(id,name){
  currentChatId=id;
  document.getElementById("chatName").textContent=name;
  messagesDiv.innerHTML="";
  show(chatScreen);

  if(currentListenerRef){ off(currentListenerRef); }
  const msgRef=ref(db,"chats/"+id+"/messages");
  currentListenerRef=msgRef;

  // IntersectionObserver for read receipts
  const observer = new IntersectionObserver((entries)=>{
    entries.forEach(async entry=>{
      if(entry.isIntersecting){
        const key = entry.target.dataset.key;
        const msg = entry.target.msgData;
        if(!msg.seen.includes(currentUser.uid)){
          msg.seen.push(currentUser.uid);
          await update(ref(db,`chats/${currentChatId}/messages/${key}`),{seen:msg.seen});
        }
      }
    });
  },{root:messagesDiv,threshold:0.9});

  function renderMessage(key,m){
    if(document.getElementById(key)) return;
    const div = document.createElement("div");
    div.id = key;
    div.dataset.key = key;
    div.classList.add("msg", m.sender===currentUser.uid?"me":"them");
    div.msgData = m;
    div.innerHTML = `${m.replyTo?`<div style="font-size:0.85rem;color:#555;border-left:3px solid #1a73e8;padding-left:6px;margin-bottom:3px;">${m.replyTo}</div>`:""}${m.text}<div class="timestamp">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}${m.seen && m.seen.includes(currentUser.uid?" ‚úÖ":" ‚ùë")}</div>`;
    messagesDiv.append(div);
    messagesDiv.scrollTop=messagesDiv.scrollHeight;

    observer.observe(div);

    // Swipe to reply
    div.addEventListener("touchstart",e=>div.startX=e.touches[0].clientX);
    div.addEventListener("touchmove",e=>{
      const diff=e.touches[0].clientX-div.startX;
      if(diff>70) showReplyBar(m.text);
    });
    div.onclick=()=>showReplyBar(m.text);
  }

  onChildAdded(msgRef,s=>renderMessage(s.key,s.val()));

  // Typing indicator
  if(typingRef) off(typingRef);
  typingRef=ref(db,"chats/"+id+"/typing");
  onValue(typingRef,s=>{
    const data=s.val()||{};
    let names=[];
    for(let uid in data){
      if(uid!==currentUser.uid && data[uid]) names.push(uid);
    }
    typingIndicator.textContent=names.length?`${names.join(", ")} typing...`:"";
  });
}

// Reply bar
function showReplyBar(text){replyBar.style.display="flex";replyText.textContent=text;replyTo=text;messageInput.focus();}
cancelReplyBtn.onclick=()=>{replyBar.style.display="none";replyText.textContent="";replyTo=null;}

// Send message
document.getElementById("sendBtn").onclick=async()=>{
  if(!messageInput.value.trim()||!currentChatId) return;
  const msg={sender:currentUser.uid,text:messageInput.value.trim(),time:Date.now(),seen:[currentUser.uid]};
  if(replyTo) msg.replyTo=replyTo;
  await push(ref(db,"chats/"+currentChatId+"/messages"),msg);
  messageInput.value="";
  replyBar.style.display="none"; replyTo=null;

  // Typing false
  set(ref(db,`chats/${currentChatId}/typing/${currentUser.uid}`),false);
};

// Typing indicator
let typingTimeout;
messageInput.addEventListener("input",()=>{
  if(!currentChatId) return;
  set(ref(db,`chats/${currentChatId}/typing/${currentUser.uid}`),true);
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{set(ref(db,`chats/${currentChatId}/typing/${currentUser.uid}`),false);},1500);
});

// Bottom menu buttons
document.getElementById("backBtn").onclick=()=>{show(chatListScreen);currentChatId=null;messagesDiv.innerHTML="";}
document.getElementById("logoutBtn").onclick=()=>signOut(auth);
document.getElementById("dmBtn").onclick=async()=>{
  const username=prompt("Enter username for DM:");
  if(!username) return;
  const usersSnap=await get(ref(db,"users")); let target=null;
  usersSnap.forEach(u=>{const v=u.val();if(v.username.toLowerCase()===username.toLowerCase())target={uid:u.key,name:v.username};});
  if(!target) return alert("User not found");

  // check existing
  const chatsSnap=await get(ref(db,"chats"));
  let chatId=null;
  if(chatsSnap.exists()) chatsSnap.forEach(c=>{
    const ch=c.val();
    if(!ch.isGroup && ch.members.includes(currentUser.uid) && ch.members.includes(target.uid)) chatId=c.key;
  });
  if(!chatId){
    const newChatRef=push(ref(db,"chats"));
    await set(newChatRef,{isGroup:false,members:[currentUser.uid,target.uid],name:target.name});
    chatId=newChatRef.key;
  }
  openChat(chatId,target.name);
};
document.getElementById("groupBtn").onclick=async()=>{
  const groupName=prompt("Group name:");
  if(!groupName) return;
  const usernames=prompt("Enter usernames to add (comma separated):");
  if(!usernames) return;
  const usersSnap=await get(ref(db,"users")); let members=[currentUser.uid];
  usernames.split(",").forEach(u=>{
    usersSnap.forEach(s=>{if(s.val().username.toLowerCase()===u.trim().toLowerCase()) members.push(s.key);});
  });
  const newChatRef=push(ref(db,"chats"));
  await set(newChatRef,{isGroup:true,name:groupName,members:[...new Set(members)]});
  loadChats();
};
</script>
</body>
</html>
