<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chat App</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: system-ui, sans-serif;
    background: #ece5dd;
  }

  /* Screens */
  #loginScreen, #chatListScreen, #chatScreen {
    display: none;
    height: 100vh;
  }

  .active {
    display: flex;
    flex-direction: column;
  }

  /* Login */
  #loginScreen {
    align-items: center;
    justify-content: center;
    background: #075e54;
    color: white;
  }

  #loginScreen input, #loginScreen button {
    padding: 10px;
    margin: 8px 0;
    border-radius: 8px;
    border: none;
    font-size: 1rem;
  }

  #loginScreen button {
    background: #25d366;
    color: white;
    cursor: pointer;
    width: 100%;
  }

  /* Chat list */
  #chatListScreen {
    background: #fff;
  }

  #chatListHeader {
    background: #075e54;
    color: white;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #chatList {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }

  .chatItem {
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
  }

  .chatItem:hover {
    background: #f5f5f5;
  }

  #newChatBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #25d366;
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 28px;
    cursor: pointer;
  }

  /* Chat screen */
  #chatScreen {
    background: #ece5dd;
  }

  #chatHeader {
    background: #075e54;
    color: white;
    padding: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    scroll-behavior: smooth;
  }

  .msg {
    max-width: 80%;
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 12px;
    position: relative;
    word-wrap: break-word;
  }

  .me {
    align-self: flex-end;
    background: #dcf8c6;
    border-bottom-right-radius: 2px;
  }

  .them {
    align-self: flex-start;
    background: #fff;
    border-bottom-left-radius: 2px;
  }

  .timestamp {
    position: absolute;
    bottom: 4px;
    right: 8px;
    font-size: 0.7rem;
    color: #666;
  }

  #replyBox {
    background: #f0f0f0;
    border-left: 3px solid #25d366;
    margin: 0 8px;
    padding: 6px;
    font-size: 0.9rem;
    display: none;
  }

  #chatInputBar {
    background: #fff;
    padding: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    border-top: 1px solid #ccc;
  }

  #message {
    flex: 1;
    padding: 10px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
    font-size: 1rem;
  }

  #sendBtn {
    background: #128c7e;
    border: none;
    color: white;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    font-weight: bold;
    cursor: pointer;
  }

</style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <main id="loginScreen" class="active">
    <div>
      <h1>Login</h1>
      <input id="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <input id="username" placeholder="Username" />
      <button id="loginBtn">Login / Register</button>
    </div>
  </main>

  <!-- CHAT LIST -->
  <main id="chatListScreen">
    <div id="chatListHeader">
      <span>Chats</span>
      <div>
        <button id="dmBtn">DM</button>
        <button id="newGroupBtn">Group</button>
      </div>
    </div>
    <div id="chatList"></div>
    <button id="newChatBtn">＋</button>
  </main>

  <!-- CHAT SCREEN -->
  <main id="chatScreen">
    <div id="chatHeader">
      <span id="chatName">Chat</span>
      <button id="backBtn">←</button>
    </div>
    <div id="messages"></div>
    <div id="replyBox"></div>
    <div id="chatInputBar">
      <input id="message" placeholder="Type a message..." />
      <button id="sendBtn">➤</button>
    </div>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getDatabase, ref, set, push, onChildAdded, get, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";


  const firebaseConfig = {
    apiKey: "AIzaSyCEdtncZpDgOSnULIjopee7GKh9h9hveKk",
    authDomain: "messagingapp-7ede5.firebaseapp.com",
    databaseURL: "https://messagingapp-7ede5-default-rtdb.firebaseio.com",
    projectId: "messagingapp-7ede5",
    storageBucket: "messagingapp-7ede5.firebasestorage.app",
    messagingSenderId: "221896974865",
    appId: "1:221896974865:web:3faca4885e48ee656907b0"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const loginScreen = document.getElementById("loginScreen");
  const chatListScreen = document.getElementById("chatListScreen");
  const chatScreen = document.getElementById("chatScreen");
  const chatList = document.getElementById("chatList");
  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("message");
  const sendBtn = document.getElementById("sendBtn");
  const replyBox = document.getElementById("replyBox");
  let currentUser = null, currentChatId = null, replyTo = null;

  const show = s => { loginScreen.style.display = chatListScreen.style.display = chatScreen.style.display = "none"; s.style.display = "flex"; };

  // LOGIN / REGISTER
  document.getElementById("loginBtn").onclick = async () => {
    const email = emailInput.value = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const username = document.getElementById("username").value;
    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      currentUser = cred.user;
    } catch {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      currentUser = cred.user;
      await set(ref(db, "users/" + currentUser.uid), { username });
    }
  };

  onAuthStateChanged(auth, async user => {
    if (user) {
      currentUser = user;
      show(chatListScreen);
      loadChats();
    }
  });

  async function loadChats() {
    chatList.innerHTML = "";
    const chatsSnap = await get(ref(db, "chats"));
    if (chatsSnap.exists()) {
      chatsSnap.forEach(c => {
        const chat = c.val();
        if (chat.members && chat.members.includes(currentUser.uid)) {
          const div = document.createElement("div");
          div.className = "chatItem";
          div.textContent = chat.name || "Chat";
          div.onclick = () => openChat(c.key, chat.name);
          chatList.append(div);
        }
      });
    }
  }

  function openChat(id, name) {
    currentChatId = id;
    messagesDiv.innerHTML = "";
    document.getElementById("chatName").textContent = name;
    show(chatScreen);
    const msgsRef = ref(db, "chats/" + id + "/messages");
    onChildAdded(msgsRef, snap => {
      const m = snap.val();
      const div = document.createElement("div");
      div.classList.add("msg", m.sender === currentUser.uid ? "me" : "them");
      div.textContent = m.text;
      const time = document.createElement("span");
      time.className = "timestamp";
      time.textContent = new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      div.appendChild(time);
      div.addEventListener("touchstart", e => { div.startX = e.touches[0].clientX; });
      div.addEventListener("touchmove", e => {
        const diff = e.touches[0].clientX - div.startX;
        if (diff > 50) replyToMessage(m);
      });
      messagesDiv.append(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      if (m.sender !== currentUser.uid) showNotification(name, m.text);
    });
  }

  function replyToMessage(m) {
    replyTo = m;
    replyBox.style.display = "block";
    replyBox.textContent = "Replying to: " + m.text.slice(0, 40);
  }

  sendBtn.onclick = async () => {
    if (!messageInput.value.trim()) return;
    const msg = { sender: currentUser.uid, text: messageInput.value, time: Date.now(), replyTo: replyTo?.text || null };
    await push(ref(db, "chats/" + currentChatId + "/messages"), msg);
    messageInput.value = "";
    replyBox.style.display = "none";
    replyTo = null;
  };

  document.getElementById("backBtn").onclick = () => {
    show(chatListScreen);
    currentChatId = null;
  };

  // NOTIFICATIONS
  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  function showNotification(title, body) {
    if (Notification.permission === "granted") new Notification(title, { body });
  }

  // New group / DM
  document.getElementById("newGroupBtn").onclick = async () => {
    const name = prompt("Group name:");
    if (!name) return;
    const chatRef = push(ref(db, "chats"));
    await set(chatRef, { name, isGroup: true, members: [currentUser.uid] });
    loadChats();
  };

  document.getElementById("dmBtn").onclick = async () => {
    const target = prompt("Username to DM:");
    const usersSnap = await get(ref(db, "users"));
    let found = null;
    usersSnap.forEach(u => { if (u.val().username === target) found = u.key; });
    if (!found) return alert("User not found.");
    const chatRef = push(ref(db, "chats"));
    await set(chatRef, { isGroup: false, members: [currentUser.uid, found], name: target });
    loadChats();
  };
</script>
</body>
</html>
