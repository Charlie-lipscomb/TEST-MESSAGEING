<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Whisp Chat</title>
<style>
html, body { margin:0; padding:0; height:100%; background:#dcefff; font-family:system-ui,sans-serif; }
main { height:100%; display:flex; flex-direction:column; }
.screen { display:none; flex-direction:column; height:100%; }
.screen.active { display:flex; }

#loginScreen { justify-content:center; align-items:center; text-align:center; padding:20px; }
#loginScreen input { display:block; width:80%; margin:8px auto; padding:10px; border-radius:8px; border:none; font-size:1rem; }
#loginBtn { background:#89c2f4; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; }

#chatListScreen { background:#fff; flex:1; position:relative; }
#chatListHeader { background:#89c2f4; color:white; padding:14px; display:flex; justify-content:space-between; align-items:center; font-weight:600; }
#chatList { flex:1; overflow-y:auto; padding-bottom:70px; }
.chatItem { padding:14px; border-bottom:1px solid #eee; cursor:pointer; }
.chatItem:hover { background:#f0f8ff; }

#bottomMenu { display:flex; justify-content:space-around; align-items:center; position:fixed; bottom:0; left:0; width:100%; background:#89c2f4; padding:10px 0; }
#bottomMenu button { background:#fff; border:none; color:#89c2f4; padding:8px 16px; border-radius:8px; font-weight:600; cursor:pointer; }

#chatScreen { background:#dcefff; display:flex; flex-direction:column; height:100%; }
#chatHeader { background:#89c2f4; color:white; padding:12px; display:flex; justify-content:space-between; align-items:center; }
#chatHeader button { background:none; border:none; color:white; font-size:1rem; cursor:pointer; }
#messages { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; }
.msg { max-width:80%; margin-bottom:10px; padding:8px 12px; border-radius:10px; position:relative; word-wrap:break-word; }
.me { align-self:flex-end; background:#c0e0ff; }
.them { align-self:flex-start; background:#fff; }
.timestamp { font-size:0.75rem; color:#666; text-align:right; margin-top:2px; }

#replyBar { display:none; background:#f0f0f0; padding:6px 10px; border-left:4px solid #89c2f4; font-size:0.9rem; }
#inputBar { display:flex; align-items:center; background:#fff; padding:8px; border-top:1px solid #ccc; }
#message { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; outline:none; }
#sendBtn { background:#89c2f4; color:white; border:none; border-radius:50%; width:42px; height:42px; margin-left:8px; font-size:1.2rem; cursor:pointer; }

@media (min-width:700px){ main{max-width:600px;margin:auto;border-radius:10px;overflow:hidden;} #bottomMenu{position:static;border-top:1px solid #ccc;} }
</style>
</head>
<body>
<main>
  <section id="loginScreen" class="screen active">
    <div>
      <h2>Whisp Login</h2>
      <input id="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <input id="username" placeholder="Username (for signup)" />
      <button id="loginBtn">Login / Register</button>
    </div>
  </section>

  <section id="chatListScreen" class="screen">
    <div id="chatListHeader">Your Chats</div>
    <div id="chatList"></div>
    <div id="bottomMenu">
      <button id="dmBtn">DM</button>
      <button id="groupBtn">Group</button>
      <button id="helpBtn">Help</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </section>

  <section id="chatScreen" class="screen">
    <div id="chatHeader">
      <button id="backBtn">←</button>
      <span id="chatName">Chat</span>
    </div>
    <div id="messages"></div>
    <div id="replyBar"></div>
    <div id="inputBar">
      <input id="message" placeholder="Type a message..." />
      <button id="sendBtn">➤</button>
    </div>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, set, push, get, onChildAdded } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEdtncZpDgOSnULIjopee7GKh9h9hveKk",
  authDomain: "messagingapp-7ede5.firebaseapp.com",
  databaseURL: "https://messagingapp-7ede5-default-rtdb.firebaseio.com",
  projectId: "messagingapp-7ede5",
  storageBucket: "messagingapp-7ede5.firebasestorage.app",
  messagingSenderId: "221896974865",
  appId: "1:221896974865:web:3faca4885e48ee656907b0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const loginScreen = document.getElementById("loginScreen");
const chatListScreen = document.getElementById("chatListScreen");
const chatScreen = document.getElementById("chatScreen");
const chatList = document.getElementById("chatList");
const messagesDiv = document.getElementById("messages");
const replyBar = document.getElementById("replyBar");
const messageInput = document.getElementById("message");

let currentUser = null, currentChatId = null, replyTo = null;

const show = s => { [loginScreen, chatListScreen, chatScreen].forEach(e=>e.classList.remove("active")); s.classList.add("active"); };

// Login/Register (fixed)
document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  const username = document.getElementById("username").value.trim();
  if (!email || !password) return alert("Enter credentials.");
  try {
    currentUser = (await signInWithEmailAndPassword(auth,email,password)).user;
  } catch {
    if (!username) return alert("Enter a username to sign up.");
    currentUser = (await createUserWithEmailAndPassword(auth,email,password)).user;
    await set(ref(db,"users/"+currentUser.uid),{username,email});
    alert("Account created successfully!");
  }
};

onAuthStateChanged(auth, async user => {
  if(user){ currentUser=user; loadChats(); show(chatListScreen); }
  else show(loginScreen);
});

async function loadChats() {
  chatList.innerHTML="";
  const chats = await get(ref(db,"chats"));
  if(chats.exists()){ chats.forEach(c=>{
    const chat=c.val();
    if(chat.members && chat.members.includes(currentUser.uid)){
      const div=document.createElement("div");
      div.className="chatItem"; div.textContent=chat.name;
      div.onclick=()=>openChat(c.key,chat.name);
      chatList.append(div);
    }
  }); }
}

// Open Chat
async function openChat(id,name){
  currentChatId=id;
  messagesDiv.innerHTML="";
  document.getElementById("chatName").textContent=name;
  show(chatScreen);
  const msgRef = ref(db,"chats/"+id+"/messages");
  onChildAdded(msgRef,s=>renderMessage(s.val(), id));
}

function renderMessage(m, chatId){
  const div=document.createElement("div");
  div.classList.add("msg", m.sender===currentUser.uid?"me":"them");
  div.innerHTML = `
    ${m.replyTo ? `<div style="font-size:0.85rem;color:#555;border-left:3px solid #89c2f4;padding-left:6px;margin-bottom:3px;">${m.replyTo}</div>` : ""}
    ${m.text}
    <div class="timestamp">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
  messagesDiv.append(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  div.addEventListener("touchstart", e=>div.startX=e.touches[0].clientX);
  div.addEventListener("touchmove", e=>{
    const diff=e.touches[0].clientX-div.startX;
    if(diff>70) showReplyBar(m.text);
  });
  div.onclick=()=>showReplyBar(m.text);

  // Notification
  if(m.sender!==currentUser.uid) showNotification("Whisp: New message", m.text);

  // Auto-reply for Whisp_Management
  if(chatId && m.sender!==currentUser.uid){
    get(ref(db,"users")).then(usersSnap=>{
      usersSnap.forEach(u=>{
        if(u.val().username==="Whisp_Management"){
          if(currentChatId && currentChatId===chatId){
            push(ref(db,"chats/"+chatId+"/messages"),{
              sender:u.key,
              text:"Thanks for contacting Whisp support! Our team will get back to you as soon as possible.",
              time:Date.now()
            });
          }
        }
      });
    });
  }
}

function showReplyBar(text){ replyTo=text; replyBar.style.display="block"; replyBar.textContent="Replying to: "+text.slice(0,40); }

document.getElementById("sendBtn").onclick=async ()=>{
  const text=messageInput.value.trim();
  if(!text||!currentChatId) return;
  await push(ref(db,"chats/"+currentChatId+"/messages"),{
    sender:currentUser.uid, text, replyTo, time:Date.now()
  });
  messageInput.value=""; replyBar.style.display="none"; replyTo=null;
};

document.getElementById("backBtn").onclick=()=>{currentChatId=null; show(chatListScreen);}
document.getElementById("logoutBtn").onclick=async ()=>{await signOut(auth); currentUser=null; show(loginScreen);}

// DM
document.getElementById("dmBtn").onclick=async ()=>{
  const uname=prompt("Username to DM:"); if(!uname) return;
  const users=await get(ref(db,"users")); let uid=null;
  users.forEach(u=>{ if(u.val().username===uname) uid=u.key; });
  if(!uid) return alert("User not found.");
  const chatsSnap=await get(ref(db,"chats")); let chatId=null;
  if(chatsSnap.exists()) chatsSnap.forEach(c=>{const chat=c.val(); if(!chat.isGroup && chat.members.includes(currentUser.uid) && chat.members.includes(uid)) chatId=c.key;});
  if(!chatId){ const refNew=push(ref(db,"chats")); await set(refNew,{name:uname,isGroup:false,members:[currentUser.uid,uid]}); chatId=refNew.key; loadChats();}
  openChat(chatId,uname);
};

// Group
document.getElementById("groupBtn").onclick=async ()=>{
  const name=prompt("Group name:"); if(!name) return;
  const input=prompt("Enter usernames (comma-separated):");
  const usernames=input?input.split(",").map(u=>u.trim()):[];
  const usersSnap=await get(ref(db,"users"));
  const memberIds=[currentUser.uid];
  usersSnap.forEach(u=>{ const val=u.val(); if(usernames.includes(val.username)) memberIds.push(u.key); });
  const refNew=push(ref(db,"chats"));
  await set(refNew,{name,isGroup:true,members:memberIds});
  loadChats();
};

// Help button
document.getElementById("helpBtn").onclick=async ()=>{
  const uname="Whisp_Management";
  const users=await get(ref(db,"users")); let uid=null;
  users.forEach(u=>{ if(u.val().username===uname) uid=u.key; });
  if(!uid){ const newUserRef=push(ref(db,"users")); await set(newUserRef,{username:uname,email:""}); uid=newUserRef.key; }
  const refNew=push(ref(db,"chats")); await set(refNew,{name:"Whisp Support",isGroup:false,members:[currentUser.uid,uid]});
  loadChats();
};

// Notifications
if("serviceWorker" in navigator){ navigator.serviceWorker.register("sw.js").then(()=>Notification.requestPermission()); }
function showNotification(title,body){ if(Notification.permission==="granted") navigator.serviceWorker.ready.then(r=>r.showNotification(title,{body,icon:"https://cdn-icons-png.flaticon.com/512/1384/1384031.png"})); }
</script>
</body>
</html>
