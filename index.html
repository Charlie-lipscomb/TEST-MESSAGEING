<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Whisp</title>
<style>
  :root{
    --cream: #f7f3e8;
    --accent: #223294;
    --accent-contrast: #ffffff;
    --muted: #6b6b6b;
    --panel-border: rgba(34,50,148,0.08);
  }

  html, body { margin:0; padding:0; height:100%; background:var(--cream); font-family:"Segoe UI", Roboto, sans-serif; color:#111; }
  main { height:100%; display:flex; flex-direction:column; }

  .screen{ display:none; flex-direction:column; height:100%; }
  .screen.active{ display:flex; }

  /* Login */
  #loginScreen{ justify-content:center; align-items:center; background:var(--accent); color:var(--accent-contrast); text-align:center; padding:20px; }
  #loginScreen h2{ font-size:2rem; margin-bottom:20px; }
  #loginScreen input{ display:block; width:80%; margin:8px auto; padding:10px; border-radius:8px; border:none; font-size:1rem; }
  #loginBtn{ background:var(--accent-contrast); color:var(--accent); border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; box-shadow:0 2px 5px rgba(0,0,0,0.08); }

  /* Chat List */
  #chatListScreen{ background:var(--cream); flex:1; }
  #chatListHeader{ background:var(--accent); color:var(--accent-contrast); padding:14px; display:flex; justify-content:space-between; align-items:center; font-weight:600; }
  #chatList{ flex:1; overflow-y:auto; padding-bottom:70px; background:var(--cream); }
  .chatItem{ padding:14px; border-bottom:1px solid var(--panel-border); cursor:pointer; transition:background 0.15s; background:transparent; }
  .chatItem:hover{ background: rgba(34,50,148,0.04); }
  .chatItem.unread{ font-weight:700; background: rgba(34,50,148,0.06); border-left:4px solid var(--accent); padding-left:10px; }

  /* Bottom Menu */
  #bottomMenu{ display:flex; justify-content:space-around; align-items:center; position:fixed; bottom:0; left:0; width:100%; background:var(--accent); padding:10px 0; box-shadow: 0 -6px 18px rgba(0,0,0,0.04); }
  #bottomMenu button{ background:var(--cream); border:none; color:var(--accent); padding:8px 16px; border-radius:8px; font-weight:600; cursor:pointer; }

  /* Chat */
  #chatScreen{ background:var(--cream); display:flex; flex-direction:column; height:100%; }
  #chatHeader{ background:var(--accent); color:var(--accent-contrast); padding:12px; display:flex; justify-content:space-between; align-items:center; }
  #chatHeader button{ background:none; border:none; color:var(--accent-contrast); font-size:1rem; cursor:pointer; }
  #messages{ flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; background:var(--cream); }
  .msg{ max-width:80%; margin-bottom:10px; padding:10px 14px; border-radius:12px; position:relative; word-wrap:break-word; box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
  .me{ align-self:flex-end; background:var(--accent); color:var(--accent-contrast); }
  .them{ align-self:flex-start; background:var(--cream); color:#111; border:1px solid var(--panel-border); }
  .timestamp{ font-size:0.75rem; color:var(--muted); text-align:right; margin-top:6px; }
  .sender{ font-size:0.8rem; color:var(--accent); font-weight:600; margin-bottom:6px; }

  /* Reply Bar */
  #replyBar{ display:none; background:rgba(34,50,148,0.06); padding:8px 10px; border-left:4px solid var(--accent); font-size:0.9rem; align-items:center; display:flex; justify-content:space-between; }
  #replyText{ flex:1; color:#222; }
  #cancelReply{ background:none; border:none; color:var(--accent); font-weight:bold; cursor:pointer; margin-left:10px; }

  #inputBar{ display:flex; align-items:center; background:var(--cream); padding:8px; border-top:1px solid var(--panel-border); }
  #message{ flex:1; padding:10px; border-radius:20px; border:1px solid var(--panel-border); outline:none; background:#fff; }
  #sendBtn{ background:var(--accent); color:var(--accent-contrast); border:none; border-radius:50%; width:44px; height:44px; margin-left:8px; font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }

  @media (min-width:700px){
    main{ max-width:640px; margin:auto; border-radius:10px; overflow:hidden; box-shadow:0 6px 30px rgba(34,50,148,0.06); }
    #bottomMenu{ position:static; border-top:1px solid var(--panel-border); }
  }
</style>
</head>
<body>
<main>
  <section id="loginScreen" class="screen active">
    <div>
      <h2>Welcome to Whisp</h2>
      <input id="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <input id="username" placeholder="Username (for signup)" />
      <button id="loginBtn">Login / Register</button>
    </div>
  </section>

  <section id="chatListScreen" class="screen">
    <div id="chatListHeader">Whisp Chats</div>
    <div id="chatList"></div>
    <div id="bottomMenu">
      <button id="dmBtn">DM</button>
      <button id="groupBtn">Group</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </section>

  <section id="chatScreen" class="screen">
    <div id="chatHeader">
      <button id="backBtn">←</button>
      <span id="chatName">Chat</span>
    </div>
    <div id="messages"></div>
    <div id="replyBar">
      <span id="replyText"></span>
      <button id="cancelReply">✖</button>
    </div>
    <div id="inputBar">
      <input id="message" placeholder="Type a message..." />
      <button id="sendBtn">➤</button>
    </div>
  </section>
</main>

<script type="module">
/*
  Replace the firebaseConfig values with your real Firebase project config.
  Example:
  const firebaseConfig = {
    apiKey: "AIzaSy....",
    authDomain: "your-app.firebaseapp.com",
    databaseURL: "https://your-app-default-rtdb.firebaseio.com",
    projectId: "your-app",
    storageBucket: "your-app.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef"
  };
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, set, push, get, onChildAdded, onValue, off, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEdtncZpDgOSnULIjopee7GKh9h9hveKk",
  authDomain: "messagingapp-7ede5.firebaseapp.com",
  databaseURL: "https://messagingapp-7ede5-default-rtdb.firebaseio.com",
  projectId: "messagingapp-7ede5",
  storageBucket: "messagingapp-7ede5.firebasestorage.app",
  messagingSenderId: "221896974865",
  appId: "1:221896974865:web:3faca4885e48ee656907b0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const loginScreen=document.getElementById("loginScreen"),
      chatListScreen=document.getElementById("chatListScreen"),
      chatScreen=document.getElementById("chatScreen"),
      chatList=document.getElementById("chatList"),
      messagesDiv=document.getElementById("messages"),
      replyBar=document.getElementById("replyBar"),
      replyText=document.getElementById("replyText"),
      cancelReplyBtn=document.getElementById("cancelReply"),
      messageInput=document.getElementById("message");

let currentUser=null, currentChatId=null, replyTo=null, currentListenerRef=null;
let currentChatIsGroup=false, chatMembers={};

// tracks which chat message refs we have attached listeners to
let activeMessageListeners = new Set();

// switch visible screen
const show=(s)=>{ [loginScreen,chatListScreen,chatScreen].forEach(e=>e.classList.remove("active")); s.classList.add("active"); };

// Login / Register handler
document.getElementById("loginBtn").onclick = async () => {
  const emailVal = document.getElementById("email").value.trim();
  const passwordVal = document.getElementById("password").value.trim();
  const usernameVal = document.getElementById("username").value.trim();
  if(!emailVal || !passwordVal) return alert("Enter credentials.");
  try {
    let cred;
    try {
      cred = await signInWithEmailAndPassword(auth, emailVal, passwordVal);
    } catch {
      cred = await createUserWithEmailAndPassword(auth, emailVal, passwordVal);
      await set(ref(db, "users/" + cred.user.uid), { username: usernameVal || emailVal.split("@")[0], email: emailVal });
    }
  } catch (e) {
    alert(e.message);
  }
};

onAuthStateChanged(auth, async user => {
  if(user){
    currentUser=user;
    // reset active listeners when a user signs in
    activeMessageListeners = new Set();
    await loadChats();
    show(chatListScreen);
    listenForUnread();
  } else {
    // detach listeners on sign out
    currentUser=null;
    activeMessageListeners.forEach(chatId => {
      try { off(ref(db,"chats/"+chatId+"/messages")); } catch(_) {}
    });
    activeMessageListeners.clear();
    show(loginScreen);
  }
});

async function loadChats(){
  chatList.innerHTML="";
  const chats=await get(ref(db,"chats"));
  if(chats.exists()){
    chats.forEach(c=>{
      const chat=c.val();
      if(chat.members && chat.members.includes(currentUser.uid)){
        const div=document.createElement("div");
        div.className="chatItem";
        div.dataset.id=c.key;
        div.textContent=chat.name;
        div.onclick=()=>openChat(c.key,chat.name);
        chatList.append(div);
      }
    });
  }
}

async function openChat(id,name){
  currentChatId=id;
  document.getElementById("chatName").textContent=name;
  messagesDiv.innerHTML="";
  show(chatScreen);

  // detach any previous single-chat listener
  if(currentListenerRef){ off(currentListenerRef); currentListenerRef=null; }

  const chatSnap=await get(ref(db,"chats/"+id));
  const chat=chatSnap.val();
  currentChatIsGroup = chat.isGroup || false;

  // load member usernames
  chatMembers={};
  if(chat.members){
    for(const uid of chat.members){
      const uSnap = await get(ref(db,"users/"+uid));
      if(uSnap.exists()) chatMembers[uid] = uSnap.val().username || "Unknown";
    }
  }

  // mark messages as read and set lastRead
  await update(ref(db,"userChats/"+currentUser.uid+"/"+id), {
    unread: false,
    lastRead: Date.now()
  });

  // close any system notifications for this chat if service worker available
  if("serviceWorker" in navigator){
    navigator.serviceWorker.getRegistration().then(reg=>{
      if(!reg) return;
      reg.getNotifications({ tag: id }).then(list=>{
        list.forEach(n => n.close());
      }).catch(()=>{});
    }).catch(()=>{});
  }

  // listen for messages in this chat to render into UI
  const msgRef=ref(db,"chats/"+id+"/messages");
  currentListenerRef=msgRef;
  onChildAdded(msgRef,s=>renderMessage(s.val()));
}

function renderMessage(m){
  const div=document.createElement("div");
  div.classList.add("msg", m.sender===currentUser.uid ? "me" : "them");

  let senderLabel="";
  if(currentChatIsGroup && m.sender!==currentUser.uid){
    const uname=chatMembers[m.sender]||"Unknown";
    senderLabel=`<div class="sender">${uname}</div>`;
  }

  div.innerHTML=`
    ${senderLabel}
    ${m.replyTo?`<div style="font-size:0.85rem;color:#555;border-left:3px solid var(--accent);padding-left:6px;margin-bottom:6px;">${m.replyTo}</div>`:""}
    ${m.text}
    <div class="timestamp">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
  `;
  messagesDiv.append(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;

  div.addEventListener("touchstart",e=>div.startX=e.touches[0].clientX);
  div.addEventListener("touchmove",e=>{
    const diff=e.touches[0].clientX-div.startX;
    if(diff>70) showReplyBar(m.text);
  });
  div.onclick=()=>showReplyBar(m.text);
}

function showReplyBar(text){
  replyTo=text;
  replyBar.style.display="flex";
  replyText.textContent="Replying to: "+text.slice(0,40);
}

cancelReplyBtn.onclick=()=>{
  replyTo=null;
  replyBar.style.display="none";
};

document.getElementById("sendBtn").onclick=async()=>{
  const text=messageInput.value.trim();
  if(!text||!currentChatId) return;
  await push(ref(db,"chats/"+currentChatId+"/messages"),{sender:currentUser.uid,text,replyTo,time:Date.now()});
  messageInput.value="";
  replyTo=null;
  replyBar.style.display="none";
};

document.getElementById("backBtn").onclick=()=>{
  currentChatId=null;
  if(currentListenerRef){ off(currentListenerRef); currentListenerRef=null; }
  show(chatListScreen);
};

document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  currentUser=null;
  show(loginScreen);
};

document.getElementById("groupBtn").onclick=async()=>{
  const name=prompt("Group name:"); if(!name) return;
  const input=prompt("Enter usernames (comma-separated):");
  const usernames=input?input.split(",").map(u=>u.trim()):[];
  const usersSnap=await get(ref(db,"users"));
  const memberIds=[currentUser.uid];
  usersSnap.forEach(u=>{
    const val=u.val();
    if(usernames.includes(val.username)) memberIds.push(u.key);
  });
  const refNew=push(ref(db,"chats"));
  await set(refNew,{name,isGroup:true,members:memberIds});
  loadChats();
};

document.getElementById("dmBtn").onclick=async()=>{
  const uname=prompt("Username to DM:");
  const users=await get(ref(db,"users"));
  let uid=null;
  users.forEach(u=>{ if(u.val().username===uname) uid=u.key; });
  if(!uid) return alert("User not found.");
  const refNew=push(ref(db,"chats"));
  await set(refNew,{name:uname,isGroup:false,members:[currentUser.uid,uid]});
  loadChats();
};

// Fixed unread and notification logic
function listenForUnread(){
  // watch userChats to update UI unread markers
  const userChatsRef = ref(db,"userChats/"+currentUser.uid);
  onValue(userChatsRef,snap=>{
    if(!snap.exists()) return;
    snap.forEach(child=>{
      const chatId=child.key;
      const data=child.val();
      const chatDiv=[...chatList.children].find(d=>d.dataset.id===chatId);
      if(chatDiv){
        if(data.unread) chatDiv.classList.add("unread");
        else chatDiv.classList.remove("unread");
      }
    });
  });

  // iterate chats once and attach one message listener per chat
  onValue(ref(db,"chats"), snap => {
    if(!snap.exists()) return;
    snap.forEach(chatSnap => {
      const chatId = chatSnap.key;
      const chat = chatSnap.val();
      if(!chat.members || !chat.members.includes(currentUser.uid)) return;

      // attach only once per chat
      if(activeMessageListeners.has(chatId)) return;
      activeMessageListeners.add(chatId);

      const msgRef = ref(db,"chats/"+chatId+"/messages");
      onChildAdded(msgRef, msgSnap => {
        const m = msgSnap.val();

        // ignore our own messages
        if(m.sender === currentUser.uid) return;

        // check user's lastRead for this chat
        get(ref(db,"userChats/"+currentUser.uid+"/"+chatId)).then(userChatSnap=>{
          const data = userChatSnap.val() || {};
          const lastRead = data.lastRead || 0;

          // only mark unread and notify if message is newer than lastRead and chat not open
          if(m.time > lastRead && currentChatId !== chatId){
            update(ref(db,"userChats/"+currentUser.uid+"/"+chatId),{ unread:true });

            // show push notification, using chatId as tag so notifications replace each other per chat
            showNotification(chat.name || "New message", m.text, chatId);
          }
        }).catch(()=>{});
      });
    });
  });
}

// service worker registration and permission
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").then(()=> {
    if(Notification.permission !== "granted" && Notification.permission !== "denied"){
      Notification.requestPermission();
    }
  }).catch(()=>{});
}

function showNotification(title, body, tag){
  if(!("Notification" in window)) return;

  if(Notification.permission === "granted" && "serviceWorker" in navigator){
    navigator.serviceWorker.ready.then(reg => {
      try {
        reg.showNotification(title, {
          body,
          icon: "https://cdn-icons-png.flaticon.com/512/906/906349.png",
          tag // groups notifications per chat so they replace instead of piling up
        });
      } catch(e){}
    }).catch(()=>{});
  } else if(Notification.permission !== "denied"){
    Notification.requestPermission().then(p => {
      if(p === "granted"){
        try { new Notification(title, { body, icon: "https://cdn-icons-png.flaticon.com/512/906/906349.png", tag }); } catch(e) {}
      }
    });
  }
}
</script>
</body>
</html>
