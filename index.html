<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Whisp üí¨</title>
<style>
  html, body {margin:0;padding:0;height:100%;font-family:"Segoe UI", Roboto, sans-serif;background:#e8f0fe;}
  main {height:100%;display:flex;flex-direction:column;max-width:600px;margin:auto;border-radius:10px;overflow:hidden;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
  
  .screen{display:none;flex-direction:column;height:100%;}
  .screen.active{display:flex;}

  /* Login */
  #loginScreen{justify-content:center;align-items:center;text-align:center;padding:20px;background:#1a73e8;color:white;}
  #loginScreen h2{font-size:2rem;margin-bottom:20px;}
  #loginScreen input{display:block;width:80%;margin:8px auto;padding:10px;border-radius:8px;border:none;font-size:1rem;}
  #loginBtn{background:#4285f4;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 2px 5px rgba(0,0,0,0.2);}

  /* Chat List */
  #chatListScreen{background:#fff;flex:1;position:relative;}
  #chatListHeader{background:#1a73e8;color:white;padding:14px;font-weight:600;position:sticky;top:0;z-index:1;}
  #chatList{flex:1;overflow-y:auto;padding-bottom:70px;}
  .chatItem{padding:14px;border-bottom:1px solid #eee;cursor:pointer;}
  .chatItem:hover{background:#f1f5ff;}

  /* Floating buttons */
  .floatingBtn{position:fixed;bottom:20px;right:20px;background:#1a73e8;color:white;border:none;border-radius:50%;width:56px;height:56px;font-size:1.5rem;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.3);}
  #newGroupBtn{right:90px;}

  /* Chat */
  #chatScreen{background:#e8f0fe;flex:1;display:flex;flex-direction:column;}
  #chatHeader{background:#1a73e8;color:white;padding:12px;display:flex;align-items:center;position:sticky;top:0;z-index:2;}
  #chatHeader button{background:none;border:none;color:white;font-size:1.2rem;cursor:pointer;margin-right:10px;}
  #chatName{flex:1;font-weight:600;text-align:center;}
  #messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;}
  .msg{max-width:75%;margin-bottom:10px;padding:8px 12px;border-radius:12px;position:relative;word-wrap:break-word;animation:fadeIn 0.2s;}
  .me{align-self:flex-end;background:#cfe2ff;}
  .them{align-self:flex-start;background:#fff;}
  .timestamp{font-size:0.75rem;color:#555;text-align:right;margin-top:2px;}

  /* Reply bar */
  #replyBar{display:none;background:#e3f2fd;padding:6px 10px;border-left:4px solid #1a73e8;font-size:0.9rem;align-items:center;display:flex;justify-content:space-between;}
  #replyText{flex:1;}
  #cancelReply{background:none;border:none;color:#1a73e8;font-weight:bold;cursor:pointer;margin-left:10px;}

  /* Input bar */
  #inputBar{display:flex;align-items:center;background:#fff;padding:8px;border-top:1px solid #ccc;position:sticky;bottom:0;}
  #message{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;outline:none;}
  #sendBtn{background:#1a73e8;color:white;border:none;border-radius:50%;width:42px;height:42px;margin-left:8px;font-size:1.2rem;cursor:pointer;}

  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
</head>
<body>
<main>
  <!-- Login -->
  <section id="loginScreen" class="screen active">
    <div>
      <h2>Whisp üí¨</h2>
      <input id="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <input id="username" placeholder="Username (signup)" />
      <button id="loginBtn">Login / Register</button>
    </div>
  </section>

  <!-- Chat List -->
  <section id="chatListScreen" class="screen">
    <div id="chatListHeader">Chats</div>
    <div id="chatList"></div>
    <button id="dmBtn" class="floatingBtn">üí¨</button>
    <button id="newGroupBtn" class="floatingBtn">üë•</button>
  </section>

  <!-- Chat Screen -->
  <section id="chatScreen" class="screen">
    <div id="chatHeader">
      <button id="backBtn">‚Üê</button>
      <span id="chatName">Chat</span>
    </div>
    <div id="messages"></div>
    <div id="replyBar">
      <span id="replyText"></span>
      <button id="cancelReply">‚úñ</button>
    </div>
    <div id="inputBar">
      <input id="message" placeholder="Type a message..." />
      <button id="sendBtn">‚û§</button>
    </div>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, set, push, get, onChildAdded, off } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCEdtncZpDgOSnULIjopee7GKh9h9hveKk",
  authDomain: "messagingapp-7ede5.firebaseapp.com",
  databaseURL: "https://messagingapp-7ede5-default-rtdb.firebaseio.com",
  projectId: "messagingapp-7ede5",
  storageBucket: "messagingapp-7ede5.firebasestorage.app",
  messagingSenderId: "221896974865",
  appId: "1:221896974865:web:3faca4885e48ee656907b0"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const loginScreen=document.getElementById("loginScreen"),
      chatListScreen=document.getElementById("chatListScreen"),
      chatScreen=document.getElementById("chatScreen"),
      chatList=document.getElementById("chatList"),
      messagesDiv=document.getElementById("messages"),
      replyBar=document.getElementById("replyBar"),
      replyText=document.getElementById("replyText"),
      cancelReplyBtn=document.getElementById("cancelReply"),
      messageInput=document.getElementById("message");

let currentUser=null, currentChatId=null, replyTo=null, currentListenerRef=null;

const show=(s)=>{[loginScreen,chatListScreen,chatScreen].forEach(e=>e.classList.remove("active"));s.classList.add("active");};

document.getElementById("loginBtn").onclick=async()=>{
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  const username=document.getElementById("username").value.trim();
  if(!email||!password)return alert("Enter credentials.");
  try{
    const cred=await signInWithEmailAndPassword(auth,email,password);
    currentUser=cred.user;
  }catch{
    const cred=await createUserWithEmailAndPassword(auth,email,password);
    currentUser=cred.user;
    await set(ref(db,"users/"+currentUser.uid),{username,email});
  }
};

onAuthStateChanged(auth,async user=>{
  if(user){currentUser=user;loadChats();show(chatListScreen);}else{show(loginScreen);}
});

async function loadChats(){
  chatList.innerHTML="";
  const chats=await get(ref(db,"chats"));
  if(chats.exists()){
    chats.forEach(c=>{
      const chat=c.val();
      if(chat.members&&chat.members.includes(currentUser.uid)){
        const div=document.createElement("div");
        div.className="chatItem";
        div.textContent=chat.name;
        div.onclick=()=>openChat(c.key,chat.name);
        chatList.append(div);
      }
    });
  }
}

async function openChat(id,name){
  currentChatId=id;
  document.getElementById("chatName").textContent=name;
  messagesDiv.innerHTML="";
  show(chatScreen);
  if(currentListenerRef){ off(currentListenerRef); }
  const msgRef=ref(db,"chats/"+id+"/messages");
  currentListenerRef=msgRef;
  onChildAdded(msgRef,s=>renderMessage(s.val()));
}

function renderMessage(m){
  const div=document.createElement("div");
  div.classList.add("msg",m.sender===currentUser.uid?"me":"them");
  div.innerHTML=`
    ${m.replyTo?`<div style="font-size:0.85rem;color:#555;border-left:3px solid #1a73e8;padding-left:6px;margin-bottom:3px;">${m.replyTo}</div>`:""}
    ${m.text}
    <div class="timestamp">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
  messagesDiv.append(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;

  // Swipe-to-reply
  div.addEventListener("touchstart",e=>div.startX=e.touches[0].clientX);
  div.addEventListener("touchmove",e=>{
    const diff=e.touches[0].clientX-div.startX;
    if(diff>70)showReplyBar(m.text);
  });
  div.onclick=()=>showReplyBar(m.text);

  // Notification
  if(m.sender!==currentUser.uid) showNotification("New message",m.text);
}

function showReplyBar(text){
  replyTo=text;
  replyBar.style.display="flex";
  replyText.textContent="Replying to: "+text.slice(0,40);
}

cancelReplyBtn.onclick=()=>{replyTo=null;replyBar.style.display="none";};

document.getElementById("sendBtn").onclick=async()=>{
  const text=messageInput.value.trim();
  if(!text||!currentChatId)return;
  await push(ref(db,"chats/"+currentChatId+"/messages"),{sender:currentUser.uid,text,replyTo,time:Date.now()});
  messageInput.value="";
  replyTo=null;
  replyBar.style.display="none";
};

document.getElementById("backBtn").onclick=()=>{currentChatId=null;if(currentListenerRef){off(currentListenerRef);}show(chatListScreen);};

document.getElementById("newGroupBtn").onclick=async()=>{
  const name=prompt("Group name:");if(!name)return;
  const input=prompt("Enter usernames (comma-separated):");
  const usernames=input?input.split(",").map(u=>u.trim()):[];
  const usersSnap=await get(ref(db,"users"));
  const memberIds=[currentUser.uid];
  usersSnap.forEach(u=>{const val=u.val();if(usernames.includes(val.username))memberIds.push(u.key);});
  const refNew=push(ref(db,"chats"));
  await set(refNew,{name,isGroup:true,members:memberIds});
  loadChats();
};

document.getElementById("dmBtn").onclick=async()=>{
  const uname=prompt("Username to DM:");
  const users=await get(ref(db,"users"));
  let uid=null;
  users.forEach(u=>{if(u.val().username===uname)uid=u.key;});
  if(!uid)return alert("User not found.");
  const refNew=push(ref(db,"chats"));
  await set(refNew,{name:uname,isGroup:false,members:[currentUser.uid,uid]});
  loadChats();
};

// Notifications
if("serviceWorker"in navigator){navigator.serviceWorker.register("sw.js").then(()=>Notification.requestPermission());}
function showNotification(title,body){
  if(!("Notification"in window))return;
  if(Notification.permission==="granted"){
    navigator.serviceWorker.ready.then(r=>r.showNotification(title,{body,icon:"https://cdn-icons-png.flaticon.com/512/906/906349.png"}));
  }
}
</script>
</body>
</html>
